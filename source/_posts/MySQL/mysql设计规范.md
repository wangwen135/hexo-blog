---
title: mysql设计规范
date: 2020-05-14 23:41
tags: 
  - MySQL
categories:
  - [MySQL]
---

占位置

没有好好整理的！！


### 基本的运维方面
装数据库的机器用固态硬盘 !

每天备份数据

主从做好

权限控制好，开发不要给生产环境的权限

#### 运维在手动操作数据库时需要注意：  
超过100万的批量写操作，要分批多次进行操作
1. 主从复制中：大批量操作可能会造成严重的主从延迟，因为当主库执行完成后，才会在从库执行
2. binlog日志为row格式时会产生大量的日志
3. 注意事物，避免拥堵业务系统

对大表数据结构的修改一定要谨慎
1. 可能会造成严重的锁表操作
2. 会导致严重的主从延时
3. 执行的时间非常不可控，修改失败导致的事物回滚同样不可控
4. 修改表结构是表级锁，在修改表结构时，影响业务系统对表的写入操作
5. 可以考虑使用pt-online-schema-change


### 命名
1. 小写字母 + 下划线（“_”）  （mysql 对大小写敏感）
2. 除非是备份表或者分表，才可以使用数字命名
3. 使用相同的前缀将关联表显示在一起 如："user_"
4. 所有数据库对象名称禁止使用mysql保留关键字
5. 临时表用 tmp_为前缀，备份表用bak_ 为前缀



### 注意
1. 数据库和表的字符集统一使用UTF8mb4，这个编码支持imog字符表情（但是目前用的多的还是UTF-8）
2. 单表数据量的大小，建议控制在500万以内，不要超过1000万
3. 一般不建议在建立表时使用预留字段，后面要用再加，不然导致系统难以维护
4. 禁止在数据库中存储图片，文件等大的二进制数据，避免使用TEXT、BLOB
5. 表的所有列定义为NOT NULL，并设置默认值。（这个不强制，但是尽量有默认值，NULL字段的查询不好优化，数据量的变化会导致执行计划不一致，NULL字段的索引需要额外空间，NULL字段的复合索引无效，NULL值可能导致索引失效）
6. 金额类数据必须使用decimal类型，double和float 有精度问题
7. 每张表上的索引数量最好不超过6个  
（控制索引的数量，好像从5.7版本开始：
一个表的最大索引数量（非主键索引）为64个，复合索引最多可以包括16个列
）
8. 每张表必须有主键，建议使用自增列，主键最好不要用int，免得超过21亿了不够用，使用bigint类型，代码中用long，对分布式ID算法也友好点 （特殊的情况除外，如动态统计表，通过定时任务维护的表）
9. 避免使用数据库约束，主外键，由程序来控制，现在多少分布式的程序，很多时候都会有异步延时处理等，或者最终一致性等
10. 尽量不用视图，自定义函数，存储过程。考虑移植性如之后转成TIDB，和分库分表等。
11. join操作尽量控制在5个表以内，尽量用程序多次查询组装数据  （控制join表的数量，注意看执行计划，避免全表扫描）
12. 不要再数据库中做运算，将相关逻辑全部放到代码层面
13. in 的值最好不要超过500（in是会走索引的），尽量使用left join或not exists来优化not in操作  
14. 不要随意使用子查询。子查询的结果会被存储到临时表中，不管是内存还是磁盘都会对性能有一定的影响  ，  嵌套子查询时多出的loop更加致命。

15. 所有表必须使用Innodb存储引擎，Innodb 支持事务，支持行级锁，更好的恢复性，高并发下性能更好，不用Innodb就可以考虑用别的存储了

16. 所有表和字段都需要添加注释



### 其他
#### InnoDB限制
- 一个表最多可以包含1017列（在MySQL 5.6.9中从1000的限制中提高）。虚拟生成的列包含在此限制中。
- 一个表最多可以包含64个 二级索引。
- InnoDB日志文件的 最大总大小为512GB。
- 



### 数据库三范式
1. 第一范式(1NF)：字段值具有原子性,不能再分(所有关系型数据库系统都满足第一范式);  
例如：姓名字段,其中姓和名是一个整体,如果区分姓和名那么必须设立两个独立字段;
2. 第二范式(2NF)：一个表必须有主键,即每行数据都能被唯一的区分;  
 备注：必须先满足第一范式;
3. 第三范式(3NF)：一个表中不能包涵其他相关表中非关键字段的信息,即数据表不能有沉余字段;  
备注：必须先满足第二范式;


一般不会完全按照这个来，比如常使用的冗余字段，如果业务上支持，则能在很大程度上提高效率



### 监控
慢日志

show slow log;


### 安全方面
预编译语句(prepareStatment)进行数据库操作，可以有效避免动态sql带来的SQL注入的问题



